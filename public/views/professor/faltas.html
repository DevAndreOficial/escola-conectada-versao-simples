<!DOCTYPE html>
<html lang="pt-AO">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Registo de Faltas - Professor | IP30 MED Angola</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../../css/global.css">
  <link rel="stylesheet" href="../../css/sidebar.css">
  <link rel="stylesheet" href="css/professor.css">
</head>
<body>
  <div class="main-wrapper">
    <div class="sidebar-overlay"></div>
    
    <!-- Sidebar -->
    <aside class="sidebar">
      <button class="sidebar-close">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
      
            <div class="sidebar-brand">

        <!-- LOGO DO SISTEMA -->
        <div class="sidebar-logo">
          <!-- Ícone escolar SVG -->
          <svg xmlns="http://www.w3.org/2000/svg" width="34" height="34" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <!-- chapéu académico -->
            <path d="M22 10L12 5 2 10l10 5 10-5z" />
            <path d="M6 12v5c3 2 9 2 12 0v-5" />
            <!-- livro -->
            <path d="M4 19h16" />
          </svg>
        </div>

        <!-- NOME DO SISTEMA -->
        <div class="sidebar-brand-text">
          <span class="sidebar-brand-title">Escola Conectada</span>
          <span class="sidebar-brand-subtitle">Sistema Escolar • MED Angola</span>
        </div>
      </div>
      
      <nav class="sidebar-nav">
        <div class="nav-group">
          <div class="nav-group-title">Principal</div>
          <div class="nav-item">
            <a href="dashboard.html" class="nav-link" data-title="Dashboard">
              <span class="nav-link-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
              </span>
              <span class="nav-link-text">Dashboard</span>
            </a>
          </div>
        </div>
        
        <div class="nav-group">
          <div class="nav-group-title">Academico</div>
          <div class="nav-item">
            <a href="turmas.html" class="nav-link" data-title="Minhas Turmas">
              <span class="nav-link-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
              </span>
              <span class="nav-link-text">Minhas Turmas</span>
            </a>
          </div>
          <div class="nav-item">
            <a href="mini-pauta.html" class="nav-link" data-title="Mini-Pauta">
              <span class="nav-link-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg>
              </span>
              <span class="nav-link-text">Mini-Pauta</span>
            </a>
          </div>
          <div class="nav-item">
            <a href="faltas.html" class="nav-link active" data-title="Faltas">
              <span class="nav-link-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/><line x1="10" y1="14" x2="14" y2="18"/><line x1="14" y1="14" x2="10" y2="18"/></svg>
              </span>
              <span class="nav-link-text">Faltas</span>
            </a>
          </div>
        </div>
        
        <div class="nav-group">
          <div class="nav-group-title">Comunicacao</div>
          <div class="nav-item">
            <a href="avisos.html" class="nav-link" data-title="Avisos">
              <span class="nav-link-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 11 18-5v12L3 13v-2z"/><path d="M11.6 16.8a3 3 0 1 1-5.8-1.6"/></svg>
              </span>
              <span class="nav-link-text">Avisos</span>
              <span class="nav-badge">3</span>
            </a>
          </div>
        </div>
        
        <div class="nav-group">
          <div class="nav-group-title">Conta</div>
          <div class="nav-item">
            <a href="perfil.html" class="nav-link" data-title="Meu Perfil">
              <span class="nav-link-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
              </span>
              <span class="nav-link-text">Meu Perfil</span>
            </a>
          </div>
          <div class="nav-item">
             <a href="../../../index.html" class="nav-link" data-title="Sair">
              <span class="nav-link-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
              </span>
              <span class="nav-link-text">Sair</span>
            </a>
          </div>
        </div>
      </nav>
      
      <div class="sidebar-footer">
        <button class="sidebar-toggle">
          <span class="sidebar-toggle-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
          </span>
          <span class="sidebar-toggle-text">Recolher menu</span>
        </button>
      </div>
    </aside>
    
    <!-- Main Content -->
    <main class="main-content">
      <header class="main-header">
        <div class="header-left">
          <button class="mobile-toggle">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
          </button>
          <h1 class="header-title">Registo de Faltas</h1>
        </div>
        <div class="header-right">
          <div class="header-user">
            <div class="header-user-avatar">JF</div>
            <div class="header-user-info">
              <span class="header-user-name">Joao Ferreira</span>
              <span class="header-user-role">Professor</span>
            </div>
          </div>
        </div>
      </header>
      
      <div class="page-content">
        <!-- Filters -->
        <div class="card mb-4">
          <div class="card-body">
            <div class="row g-3 align-items-end">
              <div class="col-md-2">
                <label class="form-label">Data</label>
                <input type="date" class="form-control" id="dataFalta" value="2026-11-15">
              </div>
              <div class="col-md-2">
                <label class="form-label">Disciplina</label>
                <select class="form-control form-select" id="selectDisciplina">
                  <option value="">Selecione...</option>
                  <option value="matematica" selected>Matematica</option>
                  <option value="fisica">Fisica</option>
                </select>
              </div>
              <div class="col-md-2">
                <label class="form-label">Classe</label>
                <select class="form-control form-select" id="selectClasse">
                  <option value="">Selecione...</option>
                  <option value="10" selected>EIA-10AD</option>
                  <option value="11">INFGEST-11AD</option>
                  <option value="12">8 Classe</option>
                  <option value="13">4ª Classe</option>
                </select>
              </div>
              <div class="col-md-2">
                <label class="form-label">Turma</label>
                <select class="form-control form-select" id="selectTurma">
                  <option value="">Selecione...</option>
                  <option value="A" selected>INFGEST-10AD</option>
                  <option value="B">Turma B</option>
                </select>
              </div>
              <div class="col-md-2">
                <label class="form-label">Periodo</label>
                <select class="form-control form-select" id="selectPeriodo">
                  <option value="">Selecione...</option>
                  <option value="manha" selected>Manha</option>
                  <option value="tarde">Tarde</option>
                </select>
              </div>
              <div class="col-md-2">
                <button class="btn btn-primary w-100" id="btnCarregar">Carregar Turma</button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Attendance Summary -->
        <div class="row g-4 mb-4">
          <div class="col-md-3">
            <div class="stat-card">
              <div class="stat-icon" style="background: rgba(59, 130, 246, 0.1); color: #3b82f6;">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>
              </div>
              <div class="stat-content">
                <span class="stat-value">32</span>
                <span class="stat-label">Total Alunos</span>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-card">
              <div class="stat-icon" style="background: rgba(16, 185, 129, 0.1); color: #10b981;">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
              </div>
              <div class="stat-content">
                <span class="stat-value" id="totalPresentes">30</span>
                <span class="stat-label">Presentes</span>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-card">
              <div class="stat-icon" style="background: rgba(239, 68, 68, 0.1); color: #ef4444;">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
              </div>
              <div class="stat-content">
                <span class="stat-value" id="totalFaltas">2</span>
                <span class="stat-label">Faltas</span>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-card">
              <div class="stat-icon" style="background: rgba(245, 158, 11, 0.1); color: #f59e0b;">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
              </div>
              <div class="stat-content">
                <span class="stat-value" id="totalAtrasos">0</span>
                <span class="stat-label">Atrasos</span>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Attendance Table -->
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h6 class="card-title mb-0">Lista de Presença - EIA-10AD - Matemática</h6>
            <div class="d-flex gap-2">
              <button class="btn btn-sm btn-outline-success" id="btnMarcarTodos">Marcar Todos Presentes</button>
            </div>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead>
                  <tr>
                    <th style="width: 60px;">N.</th>
                    <th>Nome do Aluno</th>
                    <th style="width: 140px;">Data</th>
                    <th style="width: 80px;" class="text-center">Sexo</th>
                    <th style="width: 120px;" class="text-center">Status</th>
                    <th style="width: 200px;">Observacao</th>
                    <th style="width: 100px;" class="text-center">Total Faltas</th>
                  </tr>
                </thead>
                <tbody id="tabelaPresenca">
                  <!-- sample rows (will be replaced when loading turma) -->
                  <tr>
                    <td>1</td>
                    <td>Ana Maria dos Santos</td>
                    <td><input type="date" class="form-control form-control-sm input-data" value="2026-11-15"></td>
                    <td class="text-center">F</td>
                    <td class="text-center">
                        <select class="form-select form-select-sm status-select" data-aluno="1">
                        <option value="presente" selected>Presente</option>
                        <option value="falta">Falta</option>
                        <option value="atraso">Atraso</option>
                      </select>
                    </td>
                    <td>
                      <input type="text" class="form-control form-control-sm" placeholder="Observacao...">
                    </td>
                    <td class="text-center"><span class="badge badge-success">2</span></td>
                  </tr>
                  <tr>
                    <td>2</td>
                    <td>Carlos Alberto Menezes</td>
                    <td><input type="date" class="form-control form-control-sm input-data" value="2026-11-15"></td>
                    <td class="text-center">M</td>
                    <td class="text-center">
                      <select class="form-select form-select-sm status-select" data-aluno="2">
                        <option value="presente" selected>Presente</option>
                        <option value="falta">Falta</option>
                        <option value="atraso">Atraso</option>
                      </select>
                    </td>
                    <td>
                      <input type="text" class="form-control form-control-sm" placeholder="Observacao...">
                    </td>
                    <td class="text-center"><span class="badge badge-success">1</span></td>
                  </tr>
                  <tr class="table-danger">
                    <td>3</td>
                    <td>Domingas Joana Paulo</td>
                    <td><input type="date" class="form-control form-control-sm input-data" value="2026-11-15"></td>
                    <td class="text-center">F</td>
                    <td class="text-center">
                      <select class="form-select form-select-sm status-select" data-aluno="3">
                        <option value="presente">Presente</option>
                        <option value="falta" selected>Falta</option>
                        <option value="atraso">Atraso</option>
                      </select>
                    </td>
                    <td>
                      <input type="text" class="form-control form-control-sm" placeholder="Observacao...">
                    </td>
                    <td class="text-center"><span class="badge badge-danger">8</span></td>
                  </tr>
                  <tr>
                    <td>4</td>
                    <td>Eduardo Joao Pinto</td>
                    <td><input type="date" class="form-control form-control-sm input-data" value="2026-11-15"></td>
                    <td class="text-center">M</td>
                    <td class="text-center">
                      <select class="form-select form-select-sm status-select" data-aluno="4">
                        <option value="presente" selected>Presente</option>
                        <option value="falta">Falta</option>
                        <option value="atraso">Atraso</option>
                      </select>
                    </td>
                    <td>
                      <input type="text" class="form-control form-control-sm" placeholder="Observacao...">
                    </td>
                    <td class="text-center"><span class="badge badge-success">0</span></td>
                  </tr>
                  <tr class="table-danger">
                    <td>5</td>
                    <td>Francisca Teresa Gomes</td>
                    <td><input type="date" class="form-control form-control-sm input-data" value="2026-11-15"></td>
                    <td class="text-center">F</td>
                    <td class="text-center">
                      <select class="form-select form-select-sm status-select" data-aluno="5">
                        <option value="presente">Presente</option>
                        <option value="falta" selected>Falta</option>
                        <option value="atraso">Atraso</option>
                      </select>
                    </td>
                    <td>
                      <input type="text" class="form-control form-control-sm" placeholder="Observacao..." value="Doente - informado pelo encarregado">
                    </td>
                    <td class="text-center"><span class="badge badge-warning">5</span></td>
                  </tr>
                  <tr>
                    <td>6</td>
                    <td>Gabriel Antonio Silva</td>
                    <td><input type="date" class="form-control form-control-sm input-data" value="2026-11-15"></td>
                    <td class="text-center">M</td>
                    <td class="text-center">
                      <select class="form-select form-select-sm status-select" data-aluno="6">
                        <option value="presente" selected>Presente</option>
                        <option value="falta">Falta</option>
                        <option value="atraso">Atraso</option>
                      </select>
                    </td>
                    <td>
                      <input type="text" class="form-control form-control-sm" placeholder="Observacao...">
                    </td>
                    <td class="text-center"><span class="badge badge-success">3</span></td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          <div class="card-footer d-flex justify-content-between align-items-center">
            <small class="text-muted">Alunos com mais de 10 faltas podem ser reprovados por falta</small>
            <button class="btn btn-primary" id="btnGuardarFaltas">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
              Guardar Registo
            </button>
          </div>
        </div>
      </div>
      
      <footer class="main-footer">
        <p class="mb-0">Sistema de Gestao Escolar - 2026 - Ministerio da Educacao de Angola</p>
      </footer>
    </main>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="../../js/global.js"></script>
  <script src="../../js/sidebar.js"></script>
  <script src="js/professor.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const btnCarregar = document.getElementById('btnCarregar');
      const tabela = document.getElementById('tabelaPresenca');
      const btnMarcarTodos = document.getElementById('btnMarcarTodos');
      const totalPresentesEl = document.getElementById('totalPresentes');
      const totalFaltasEl = document.getElementById('totalFaltas');
      const totalAtrasosEl = document.getElementById('totalAtrasos');
      const btnGuardar = document.getElementById('btnGuardarFaltas');

      function gerarAlunosExemplo(classe, turma) {
        const nomes = ['Ana Pereira','Pedro Santos','João Costa','Maria Silva','Luís Gomes','Rita Alves','Carlos Mendes','Sofia Ribeiro','Miguel Sousa','Paula Rocha','Bruno Dias','Inês Matos'];
        return nomes.map((n, i) => ({
          numero: i + 1,
          nome: n + ' ' + turma,
          sexo: i % 2 === 0 ? 'F' : 'M',
          faltasTotais: 0
        }));
      }

      function criarLinhaAluno(aluno) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${aluno.numero}</td>
          <td>${aluno.nome}</td>
          <td><input type="date" class="form-control form-control-sm input-data" value="${document.getElementById('dataFalta').value}" /></td>
          <td class="text-center">${aluno.sexo}</td>
          <td class="text-center">
            <select class="form-select form-select-sm status-select" data-aluno="${aluno.numero}">
              <option value="presente" selected>Presente</option>
              <option value="falta">Falta</option>
              <option value="atraso">Atraso</option>
            </select>
          </td>
          <td><input type="text" class="form-control form-control-sm obs-input" placeholder="Observacao..."></td>
          <td class="text-center"><span class="badge badge-success">0</span></td>
        `;

        // events
        const select = tr.querySelector('.status-select');
        const obs = tr.querySelector('.obs-input');
        select.addEventListener('change', () => atualizarLinha(tr));

        return tr;
      }

      function atualizarLinha(tr) {
        const select = tr.querySelector('.status-select');
        const badge = tr.querySelector('td:last-child span');
        const status = select.value;
        // update badge color/text depending on status (we keep badge as total faltas placeholder)
        if (status === 'presente') {
          tr.classList.remove('table-danger');
        } else if (status === 'falta') {
          tr.classList.add('table-danger');
        } else if (status === 'atraso') {
          tr.classList.remove('table-danger');
        }
        atualizarTotais();
      }

      function atualizarTotais() {
        const rows = Array.from(tabela.querySelectorAll('tr'));
        let presentes = 0, faltas = 0, atrasos = 0;
        rows.forEach(r => {
          const sel = r.querySelector('.status-select');
          if (!sel) return;
          const v = sel.value;
          if (v === 'presente') presentes++;
          if (v === 'falta') faltas++;
          if (v === 'atraso') atrasos++;
        });
        totalPresentesEl.textContent = presentes;
        totalFaltasEl.textContent = faltas;
        totalAtrasosEl.textContent = atrasos;
      }

      btnCarregar.addEventListener('click', function() {
        const disciplina = document.getElementById('selectDisciplina').value;
        const classe = document.getElementById('selectClasse').value;
        const turma = document.getElementById('selectTurma').value;
        if (!disciplina || !classe || !turma) {
          if (window.Utils && Utils.mostrarNotificacao) Utils.mostrarNotificacao('Seleccione disciplina, classe e turma.', 'warning');
          else alert('Seleccione disciplina, classe e turma.');
          return;
        }
        const alunos = gerarAlunosExemplo(classe, turma);
        tabela.innerHTML = '';
        alunos.forEach(a => tabela.appendChild(criarLinhaAluno(a)));
        atualizarTotais();
        if (window.Utils && Utils.mostrarNotificacao) Utils.mostrarNotificacao('Turma carregada (exemplo).', 'success');
      });

      btnMarcarTodos.addEventListener('click', function() {
        const selects = tabela.querySelectorAll('.status-select');
        selects.forEach(s => s.value = 'presente');
        atualizarTotais();
      });

      // submit to backend
      btnGuardar.addEventListener('click', function() {
        const disciplina = document.getElementById('selectDisciplina').value;
        const classe = document.getElementById('selectClasse').value;
        const turma = document.getElementById('selectTurma').value;
        const periodo = document.getElementById('selectPeriodo').value;

        const rows = Array.from(tabela.querySelectorAll('tr'));
        const registros = rows.map(r => {
          const numero = r.querySelector('td:first-child') ? r.querySelector('td:first-child').textContent.trim() : '';
          const nome = r.querySelector('td:nth-child(2)') ? r.querySelector('td:nth-child(2)').textContent.trim() : '';
          const data = r.querySelector('.input-data') ? r.querySelector('.input-data').value : document.getElementById('dataFalta').value;
          const sexo = r.querySelector('td:nth-child(4)') ? r.querySelector('td:nth-child(4)').textContent.trim() : '';
          const status = r.querySelector('.status-select') ? r.querySelector('.status-select').value : '';
          const observacao = r.querySelector('.obs-input') ? r.querySelector('.obs-input').value : '';
          const totalFaltas = r.querySelector('td:last-child span') ? r.querySelector('td:last-child span').textContent.trim() : '0';
          return { numero, nome, data, sexo, status, observacao, totalFaltas };
        }).filter(x => x.nome);

        const payload = { disciplina, classe, turma, periodo, registros };
        console.log('Enviando faltas payload:', payload);

        // endpoint configurável: defina window.FALTAS_API_ENDPOINT antes do script se necessário
        const endpoint = window.FALTAS_API_ENDPOINT || (window.location.origin + '/api/faltas');
        console.log('Usando endpoint:', endpoint);

        // Detectar se a página está a correr via file:// ou origin é 'null' — nesses casos não tente fetch (evita erro CORS local)
        const isFileProtocol = window.location.protocol === 'file:' || (window.location.origin === 'null');
        if (isFileProtocol || endpoint.startsWith('file:') || endpoint.includes('null')) {
          console.warn('Página servido via file:// ou endpoint inválido — submissão será simulada. Defina window.FALTAS_API_ENDPOINT para ativar envio real.');
          console.log('Payload (simulado):', payload);
          if (window.Utils && Utils.mostrarNotificacao) Utils.mostrarNotificacao('Submissão simulada: página carregada localmente. Configure window.FALTAS_API_ENDPOINT para enviar ao backend.', 'info');
          return;
        }

        fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        }).then(async res => {
          const text = await res.text().catch(() => '');
          if (res.ok) {
            console.log('Resposta do servidor:', res.status, text);
            if (window.Utils && Utils.mostrarNotificacao) Utils.mostrarNotificacao('Registo de faltas enviado com sucesso.', 'success');
            else alert('Registo de faltas enviado com sucesso.');
          } else {
            console.error('Erro HTTP ao enviar registos:', res.status, text);
            if (window.Utils && Utils.mostrarNotificacao) Utils.mostrarNotificacao('Erro ao enviar: ' + (text || res.statusText + ' (' + res.status + ')'), 'danger');
            else alert('Erro ao enviar: ' + (text || res.statusText + ' (' + res.status + ')'));
          }
        }).catch(err => {
          console.error('Falha network ao enviar registos:', err);
          if (window.Utils && Utils.mostrarNotificacao) Utils.mostrarNotificacao('Erro de rede ao enviar registos. Ver console para mais detalhes.', 'danger');
          else alert('Erro de rede ao enviar registos. Ver console para mais detalhes.');
        });
      });

      // attach change listeners for existing sample rows
      tabela.querySelectorAll('.status-select').forEach(s => s.addEventListener('change', () => atualizarTotais()));
      atualizarTotais();
    });
  </script>
</body>
</html>
